{"version":3,"file":"feedback.min.js","sources":["../src/feedback.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package\n * @author  2023 3iPunt <https://www.tresipunt.com/>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable no-unused-vars */\n/* eslint-disable no-console */\n\ndefine([\n        'jquery',\n        'core/str',\n        'core/ajax',\n        'core/templates'\n    ], function ($, Str, Ajax, Templates) {\n        \"use strict\";\n\n        /**\n         *\n         */\n        let REGIONS = {\n            CONTENT: '[data-region=\"mod_tipcoll-content\"]',\n            QUESTION: '[data-region=\"mod-tipcoll-question\"]',\n            RESPONSE: '[data-region=\"mod-tipcoll-response\"]',\n        };\n\n        /**\n         *\n         */\n        let ACTION = {\n            START: '[data-action=\"start\"]',\n            SEND_RESPONSE: '[data-action=\"send_response\"]',\n            SELECT_RESPONSE: '[data-action=\"select_response\"]',\n            NAV_ITEM: '[data-region=\"nav-item\"]',\n        };\n\n        /**\n         *\n         */\n        let SERVICES = {\n            RESPONSE: 'mod_tipcoll_response_question_feedback',\n        };\n\n        /**\n         * @param {String} region\n         * @param {Number} cmid\n         *\n         * @constructor\n         */\n        function Feedback(region, cmid) {\n            this.node = $(region + '[data-id=\"' + cmid + '\"]');\n            this.cmid = cmid;\n            this.setResponses();\n            this.node.find(ACTION.START).on('click', this.onStartClick.bind(this));\n            this.node.find(ACTION.NAV_ITEM).on('click', this.onStartClick.bind(this));\n            this.node.find(ACTION.SELECT_RESPONSE).on('click', this.onSelectResponseClick.bind(this));\n            this.node.find(ACTION.SEND_RESPONSE).on('click', this.onSendResponseClick.bind(this));\n        }\n\n        Feedback.prototype.setResponses = function (e) {\n            let questions = this.node.find(REGIONS.QUESTION);\n            let quizs = [];\n            questions.each(function(index) {\n                let quiz = $(this);\n                let qid = quiz.data('questionid');\n                let resps = quiz.find(REGIONS.RESPONSE);\n                let responses = [];\n                resps.each(function(index) {\n                    let resp = $(this);\n                    let rid = resp.data('responseid');\n                    responses.push(rid);\n                });\n                let question = {\n                    'id': qid,\n                    'responses': responses,\n                    'select' : null\n                };\n                quizs.push(question);\n            });\n            this.responses = quizs;\n        };\n\n        Feedback.prototype.updateStatus = function (e) {\n            let responsesCurrent = this.responses;\n            let questions = this.node.find(REGIONS.QUESTION);\n            questions.each(function(index) {\n                let quiz = $(this);\n                let qid = quiz.data('questionid');\n                let resps = quiz.find(REGIONS.RESPONSE);\n                resps.each(function(index) {\n                    let resp = $(this);\n                    let rid = resp.data('responseid');\n                    resp.removeClass('ok');\n                    responsesCurrent.forEach(function (element, index, array) {\n                        if (element.id === qid) {\n                            if(element.select === rid ) {\n                                resp.addClass('ok');\n                            }\n                        }\n                    });\n                });\n            });\n            let already = true;\n            responsesCurrent.forEach(function (element, index, array) {\n                if (element.select === null) {\n                    already = false;\n                    return true;\n                }\n            });\n            if (already) {\n                this.node.find(ACTION.SEND_RESPONSE).removeAttr('disabled');\n            }\n        };\n\n        Feedback.prototype.onStartClick = function (e) {\n            let sendButton = this.node.find(ACTION.SEND_RESPONSE + '[data-id=\"' + this.cmid + '\"]');\n            sendButton.show();\n        };\n\n        Feedback.prototype.onSelectResponseClick = function (e) {\n            let rid = $(e.currentTarget).data('responseid');\n            let qid = $(e.currentTarget).data('questionid');\n            this.responses.forEach(function (element, index, array) {\n                if(element.id === qid) {\n                    element.select = rid;\n                    $(e.currentTarget).addClass('ok');\n                    return true;\n                }\n            });\n            this.updateStatus();\n        };\n\n        Feedback.prototype.getResponse = function (e) {\n            let response = [];\n            this.responses.forEach(function (element, index, array) {\n                response.push({'qid': element.id, 'rid' : element.select});\n            });\n            return response;\n        };\n\n        Feedback.prototype.onSendResponseClick = function (e) {\n            this.node.find(ACTION.SEND_RESPONSE).attr('disabled', true);\n            const response = this.getResponse();\n            const request = {\n                methodname: SERVICES.RESPONSE,\n                args: {\n                    cmid: this.cmid,\n                    response: response\n                }\n            };\n            Ajax.call([request])[0].done(function(response) {\n                if (response.success) {\n                    location.reload();\n                } else {\n                   console.log(response);\n                }\n            }).fail(function(fail) {\n                console.log(fail);\n            });\n        };\n\n        /** @type {jQuery} The jQuery node for the region. */\n        Feedback.prototype.node = null;\n\n        return {\n            /**\n             * Init\n             *\n             * @param {String} region\n             * @param {Number} cmid\n             *\n             * @return {Feedback}\n             */\n            initFeedback: function(region, cmid) {\n                return new Feedback(region, cmid);\n            }\n        };\n    }\n);"],"names":["define","$","Str","Ajax","Templates","REGIONS","ACTION","SERVICES","Feedback","region","cmid","node","setResponses","find","on","this","onStartClick","bind","onSelectResponseClick","onSendResponseClick","prototype","e","questions","quizs","each","index","quiz","qid","data","resps","responses","rid","push","question","updateStatus","responsesCurrent","resp","removeClass","forEach","element","array","id","select","addClass","already","removeAttr","show","currentTarget","getResponse","response","attr","request","methodname","args","call","done","success","location","reload","console","log","fail","initFeedback"],"mappings":";;;;;AAwBAA,8BAAO,CACC,SACA,WACA,YACA,mBACD,SAAUC,EAAGC,IAAKC,KAAMC,eAMnBC,iBAEU,uCAFVA,iBAGU,uCAMVC,aACO,wBADPA,qBAEe,gCAFfA,uBAGiB,kCAHjBA,gBAIU,2BAMVC,kBACU,kDASLC,SAASC,OAAQC,WACjBC,KAAOV,EAAEQ,OAAS,aAAeC,KAAO,WACxCA,KAAOA,UACPE,oBACAD,KAAKE,KAAKP,cAAcQ,GAAG,QAASC,KAAKC,aAAaC,KAAKF,YAC3DJ,KAAKE,KAAKP,iBAAiBQ,GAAG,QAASC,KAAKC,aAAaC,KAAKF,YAC9DJ,KAAKE,KAAKP,wBAAwBQ,GAAG,QAASC,KAAKG,sBAAsBD,KAAKF,YAC9EJ,KAAKE,KAAKP,sBAAsBQ,GAAG,QAASC,KAAKI,oBAAoBF,KAAKF,cAGnFP,SAASY,UAAUR,aAAe,SAAUS,OACpCC,UAAYP,KAAKJ,KAAKE,KAAKR,kBAC3BkB,MAAQ,GACZD,UAAUE,MAAK,SAASC,WAChBC,KAAOzB,EAAEc,MACTY,IAAMD,KAAKE,KAAK,cAChBC,MAAQH,KAAKb,KAAKR,kBAClByB,UAAY,GAChBD,MAAML,MAAK,SAASC,WAEZM,IADO9B,EAAEc,MACEa,KAAK,cACpBE,UAAUE,KAAKD,YAEfE,SAAW,IACLN,cACOG,iBACF,MAEfP,MAAMS,KAAKC,kBAEVH,UAAYP,OAGrBf,SAASY,UAAUc,aAAe,SAAUb,OACpCc,iBAAmBpB,KAAKe,UACZf,KAAKJ,KAAKE,KAAKR,kBACrBmB,MAAK,SAASC,WAChBC,KAAOzB,EAAEc,MACTY,IAAMD,KAAKE,KAAK,cACRF,KAAKb,KAAKR,kBAChBmB,MAAK,SAASC,WACZW,KAAOnC,EAAEc,MACTgB,IAAMK,KAAKR,KAAK,cACpBQ,KAAKC,YAAY,MACjBF,iBAAiBG,SAAQ,SAAUC,QAASd,MAAOe,OAC3CD,QAAQE,KAAOd,KACZY,QAAQG,SAAWX,KAClBK,KAAKO,SAAS,mBAM9BC,SAAU,EACdT,iBAAiBG,SAAQ,SAAUC,QAASd,MAAOe,UACxB,OAAnBD,QAAQG,cACRE,SAAU,GACH,KAGXA,cACKjC,KAAKE,KAAKP,sBAAsBuC,WAAW,aAIxDrC,SAASY,UAAUJ,aAAe,SAAUK,GACvBN,KAAKJ,KAAKE,KAAKP,qBAAuB,aAAeS,KAAKL,KAAO,MACvEoC,QAGftC,SAASY,UAAUF,sBAAwB,SAAUG,OAC7CU,IAAM9B,EAAEoB,EAAE0B,eAAenB,KAAK,cAC9BD,IAAM1B,EAAEoB,EAAE0B,eAAenB,KAAK,mBAC7BE,UAAUQ,SAAQ,SAAUC,QAASd,MAAOe,UAC1CD,QAAQE,KAAOd,WACdY,QAAQG,OAASX,IACjB9B,EAAEoB,EAAE0B,eAAeJ,SAAS,OACrB,UAGVT,gBAGT1B,SAASY,UAAU4B,YAAc,SAAU3B,OACnC4B,SAAW,eACVnB,UAAUQ,SAAQ,SAAUC,QAASd,MAAOe,OAC7CS,SAASjB,KAAK,KAAQO,QAAQE,OAAYF,QAAQG,YAE/CO,UAGXzC,SAASY,UAAUD,oBAAsB,SAAUE,QAC1CV,KAAKE,KAAKP,sBAAsB4C,KAAK,YAAY,SAChDD,SAAWlC,KAAKiC,cAChBG,QAAU,CACZC,WAAY7C,kBACZ8C,KAAM,CACF3C,KAAMK,KAAKL,KACXuC,SAAUA,WAGlB9C,KAAKmD,KAAK,CAACH,UAAU,GAAGI,MAAK,SAASN,UAC9BA,SAASO,QACTC,SAASC,SAEVC,QAAQC,IAAIX,aAEhBY,MAAK,SAASA,MACbF,QAAQC,IAAIC,UAKpBrD,SAASY,UAAUT,KAAO,KAEnB,CASHmD,aAAc,SAASrD,OAAQC,aACpB,IAAIF,SAASC,OAAQC"}